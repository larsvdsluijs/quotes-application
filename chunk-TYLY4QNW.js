import{Ba as O,Da as R,Fa as g,Ga as u,Ha as m,Ia as h,Ja as D,La as v,Ma as A,Na as y,Oa as V,Pa as $,a as i,b as l,c as _,d,e as f,j as q,m as x,p as b,za as j}from"./chunk-GC5IC5FD.js";var C=class w{constructor(o,e){this.firestore=o;this.auth=e;this.user$=O(this.auth)}user$;convertTimestamps(o){let e=i({},o);return e.createdAt&&typeof e.createdAt.toDate=="function"&&(e.createdAt=e.createdAt.toDate()),e.date&&typeof e.date.toDate=="function"&&(e.date=e.date.toDate()),e.votes&&Array.isArray(e.votes)&&(e.votes=e.votes.map(t=>l(i({},t),{timestamp:t.timestamp&&typeof t.timestamp.toDate=="function"?t.timestamp.toDate():t.timestamp}))),e}addQuote(o){return d(this,null,function*(){let e=yield this.user$.pipe(q(1)).toPromise();if(!e)throw new Error("User not authenticated");let t=i({},o);t.date||delete t.date;let r=l(i({},t),{createdBy:e.uid||"",createdAt:new Date,status:"pending",votes:[]});console.log("Adding quote to pending_quotes:",r),yield g(u(this.firestore,"pending_quotes"),r),console.log("Quote added successfully")})}getPendingQuotes(){let o=u(this.firestore,"pending_quotes"),e=y(o,A("createdAt","desc"));return new f(t=>v(e,a=>{let n=[];a.forEach(s=>{let c=this.convertTimestamps(s.data());n.push(i({id:s.id},c))}),t.next(n)}))}getApprovedQuotes(){let o=u(this.firestore,"quotes"),e=y(o,A("createdAt","desc"));return new f(t=>v(e,a=>{let n=[];a.forEach(s=>{let c=this.convertTimestamps(s.data());n.push(i({id:s.id},c))}),t.next(n)}))}voteOnQuote(o,e){return d(this,null,function*(){let t=yield this.user$.pipe(q(1)).toPromise();if(!t)throw new Error("User not authenticated");console.log("Voting on quote:",o,"with vote:",e,"by user:",t.uid);try{let r=h(this.firestore,"pending_quotes",o),a=yield D(y(u(this.firestore,"pending_quotes"),$("__name__","==",o)));if(a.empty)throw console.error("Quote not found:",o),new Error("Quote not found");let n=a.docs[0].data(),s=this.convertTimestamps(n);console.log("Current quote data:",s),s.votes||(s.votes=[]);let c=s.votes.findIndex(p=>p.userId===t.uid);c!==-1?(s.votes[c].vote=e,s.votes[c].timestamp=new Date,console.log("Updated existing vote")):(s.votes.push({userId:t.uid,vote:e,timestamp:new Date}),console.log("Added new vote"));let Q=yield this.getTotalUsers(),P=s.votes.filter(p=>p.vote==="yes").length,U=s.votes.filter(p=>p.vote==="no").length,E=P/Q*100,T=U/Q*100;console.log("Vote stats:",{yesVotes:P,noVotes:U,totalUsers:Q,approvalPercentage:E,rejectionPercentage:T}),E>=50?(console.log("Quote approved, moving to quotes collection"),yield g(u(this.firestore,"quotes"),l(i({},s),{status:"approved"})),yield m(r),console.log("Quote moved to approved and removed from pending")):T>=50?(console.log("Quote rejected, removing from pending"),yield m(r),console.log("Quote rejected and removed from pending")):(console.log("Updating votes in pending quote"),yield V(r,{votes:s.votes}),console.log("Votes updated successfully"))}catch(r){throw console.error("Error in voteOnQuote:",r),r}})}getTotalUsers(){return d(this,null,function*(){try{let o=u(this.firestore,"users"),e=yield D(o);return console.log("Total users in database:",e.size),e.size}catch(o){return console.error("Error getting total users:",o),1}})}getTotalUsersCount(){return d(this,null,function*(){return this.getTotalUsers()})}getAllUsers(){let o=u(this.firestore,"users");return new f(e=>v(o,r=>{let a=[];r.forEach(n=>{a.push(i({id:n.id},n.data()))}),e.next(a)}))}deleteQuote(o,e="quotes"){return d(this,null,function*(){try{let t=h(this.firestore,e,o);yield m(t),console.log(`Quote ${o} deleted from ${e}`)}catch(t){throw console.error("Error deleting quote:",t),t}})}updateQuote(o){return d(this,null,function*(){try{console.log("Updating quote:",o.id);let t=h(this.firestore,"quotes",o.id);yield m(t),console.log("Quote removed from approved quotes");let e=l(i({},o),{votes:[],status:"pending"}),{id:a}=e,n=_(e,["id"]);yield g(u(this.firestore,"pending_quotes"),n),console.log("Quote moved back to pending quotes")}catch(t){throw console.error("Error updating quote:",t),t}})}static \u0275fac=function(e){return new(e||w)(b(R),b(j))};static \u0275prov=x({token:w,factory:w.\u0275fac,providedIn:"root"})};export{C as a};
